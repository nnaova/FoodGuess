name: iOS Build

# Ce workflow peut √™tre ex√©cut√© manuellement ou d√©clench√© automatiquement apr√®s une release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version √† utiliser pour la build (ex: 1.2.3)"
        required: true
        default: ""
  # Ajout du d√©clencheur pour les nouvelles releases
  release:
    types: [published]

# D√©finition des permissions n√©cessaires
permissions:
  contents: write

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.0"
          channel: "stable"

      - name: Display Flutter & Dart versions
        run: |
          flutter --version
          dart --version

      - name: Ajuster les d√©pendances pour la compatibilit√©
        run: |
          # Sauvegarder le pubspec.yaml original
          cp pubspec.yaml pubspec.yaml.bak

          # Modifier les versions des d√©pendances pour √™tre compatibles avec Flutter 3.19.0
          sed -i 's/flutter_lints: \^5.0.0/flutter_lints: \^2.0.0/' pubspec.yaml
          sed -i 's/cupertino_icons: \^1.0.8/cupertino_icons: \^1.0.2/' pubspec.yaml

          echo "Contenu du pubspec.yaml modifi√©:"
          cat pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Fix ColorScheme in main.dart
        run: |
          echo "Correction du ColorScheme dans main.dart pour ajouter les param√®tres requis..."
          # V√©rifier si les param√®tres background et onBackground sont d√©j√† pr√©sents
          if ! grep -q "background:" lib/main.dart || ! grep -q "onBackground:" lib/main.dart; then
            # Sauvegarder le fichier original
            cp lib/main.dart lib/main.dart.bak
            
            # Ajouter les param√®tres manquants au ColorScheme
            sed -i '/surface: AppColors.beigeLight,/a\\          background: AppColors.beigeLight,\n          onBackground: Colors.black87,' lib/main.dart
            
            echo "ColorScheme mis √† jour avec les param√®tres requis."
            grep -A 15 "colorScheme:" lib/main.dart
          else
            echo "ColorScheme semble d√©j√† contenir les param√®tres requis."
          fi

      # D√©terminer la version √† partir de l'√©v√©nement d√©clencheur ou du param√®tre d'entr√©e
      - name: Set version
        id: set_version
        run: |
          # Si d√©clench√© par une release, extraire la version du tag (v1.2.3 -> 1.2.3)
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION=$(echo ${{ github.event.release.tag_name }} | sed 's/^v//')
            echo "√âv√©nement de release d√©tect√©, version extraite: $VERSION"
          else
            # Si d√©clench√© manuellement, utiliser la version fournie
            VERSION="${{ github.event.inputs.version }}"
            echo "√âv√©nement manuel d√©tect√©, version utilis√©e: $VERSION"
          fi

          # V√©rifier si la version est vide et utiliser une valeur par d√©faut si n√©cessaire
          if [ -z "$VERSION" ]; then
            # Essayer d'extraire depuis pubspec.yaml
            if [ -f "pubspec.yaml" ]; then
              VERSION=$(grep -m 1 "version:" pubspec.yaml | awk '{print $2}' | tr -d '"'"'" | cut -d '+' -f1)
            fi
            
            # Si toujours vide, utiliser une version par d√©faut
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
              echo "Aucune version d√©tect√©e, utilisation de la valeur par d√©faut: $VERSION"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version finale utilis√©e: $VERSION"

      - name: Build iOS Archive
        run: |
          echo "Construction de l'archive iOS pour la version ${{ steps.set_version.outputs.version }}..."
          # Mise √† jour de CocoaPods si n√©cessaire
          cd ios && pod repo update && cd ..

          # Pr√©paration de l'environnement Xcode
          flutter build ios --release --no-codesign

          # V√©rification du chemin du build
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "R√©pertoire Runner.app trouv√© dans build/ios/iphoneos/"
          else
            echo "Recherche du chemin du Runner.app..."
            find build -name "Runner.app" -type d
          fi

          # Cr√©ation d'un IPA sans signature
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          mkdir -p release-assets
          zip -r release-assets/foodguess-${{ steps.set_version.outputs.version }}-unsigned.ipa Payload
          rm -rf Payload

      - name: Upload iOS build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: release-assets/*.ipa

      # G√©rer les releases en fonction du type d'√©v√©nement
      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.set_version.outputs.version }}
          name: iOS Release v${{ steps.set_version.outputs.version }}
          body: |
            # Build iOS FoodGuess v${{ steps.set_version.outputs.version }}

            Cette version iOS a √©t√© compil√©e automatiquement sur un runner macOS.

            ## T√©l√©chargements
            - [üì± Application iOS (non sign√©e)](https://github.com/${{ github.repository }}/releases/download/v${{ steps.set_version.outputs.version }}/foodguess-${{ steps.set_version.outputs.version }}-unsigned.ipa)

            ## Notes
            Cette build n'est pas sign√©e et ne peut pas √™tre install√©e directement sur des appareils iOS.
            Pour installer l'application, vous devez la signer avec votre propre certificat de d√©veloppeur.

            ## Informations techniques
            - Date de construction: ${{ github.event.repository.updated_at }}
            - Flutter: 3.19.0 (stable)
            - Version: ${{ steps.set_version.outputs.version }}
          files: |
            release-assets/*.ipa
          draft: false
          prerelease: false
